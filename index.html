<!doctype html>
<html>
<head>
<title>ETHBlockByte</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="text/javascript" src="node_modules/bignumber.js/bignumber.min.js"></script>
<script type="text/javascript" src="node_modules/web3/dist/web3-light.js"></script>
<link href="css/nouislider.min.css?v=1000" rel="stylesheet">
<script src="js/nouislider.min.js?v=1000"></script>
<style>
body, input, button {
    font-family: monospace;
    font-size: 1.2rem;
    background-color: #fff;
}
section {
    width: 640px;
}
article {
    border: 3px dashed #ddd;
    margin-bottom: 20px;
}
#max_fee {
    color: #a00;
}
#balance {
    color: #0a0;
}
.winner {
    color: #0a0;
}
.line {
    padding: 0 20px;
    font-weight: bold;
    margin: 10px 0;
    border-bottom: 1px dotted #ccc;
}
.line span {
    font-weight: normal;
    float: right;
}
#submit {
    margin: 0 100px 60px 100px;
    width: 400px;
}
#error {
    color: #f00;
}
time {
    display: inline-block;
    width: 200px;
}
#guess-slider, #fee-slider {
    width: 400px;
    margin: 60px 100px;
}
.red {
    background-color: #a00;
}
.green {
    background-color: #0a0;
}
</style>

<script type="text/javascript" src="bin/conf.js"></script>
<script type="text/javascript">

    var bootstrap = function () {

        var Web3 = require('web3');
        var BigNumber = require('bignumber.js');
        
        if (typeof window.web3 !== 'undefined') {
              var web3 = new Web3(window.web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers, for local dev
              var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        if (!web3.eth.accounts[0]) {
            var interval = setInterval(function () {
                if (web3.eth.accounts[0]) {
                    clearInterval(interval);
                    document.getElementById('error').innerText = '';
                }
                else {
                    document.getElementById('error').innerText = 'Unlock metamstk account';
                }
            }, 5000);
        }

        var data = function  (address, contract) {
            return {
                contract: contract,
                address: address,
                owner: null,
                create_block: 0,
                balance: 0,
                max_fee: 0,
                last_result: null
            };
        };

        var init = function (address, contract) {
            var proxy = new Proxy(data(address, contract), {
                set: function (obj, prop, value) {
                    obj[prop] = value;
                    switch (prop) {
                        case 'balance':
                        case 'max_fee':
                            document.getElementById(prop).innerText = parseFloat(web3.fromWei(value, 'ether')).toFixed(5) + 'ETH';
                        break;

                        case 'last_result':
                            document.getElementById(prop).innerText = parseInt(value);
                        break;

                        case 'address':
                        case 'owner':
                            var a = document.createElement('a');
                            a.setAttribute('href', 'https://ropsten.etherscan.io/address/' + value);
                            a.setAttribute('target', '_blank');
                            a.innerText = value;
                            document.getElementById(prop).removeChild(document.getElementById(prop).firstChild);
                            document.getElementById(prop).append(a);
                        break;

                        default:
                            document.getElementById(prop).innerText = value;
                        break;
                    }
                    return true;
                }
            });
            var all_events = proxy.contract.allEvents(function (e, r) {
                switch (r.event) {
                    case 'Play':
                        render_play(r);
                        proxy.last_result = parseInt(r.args._result);
                    break;

                    case 'Balance':
                        proxy.balance = r.args._balance;
                        proxy.contract.max_fee(function(e, r) {
                            proxy.max_fee = r;
                            max_fee = parseInt(r / step * step);
                            document.getElementById('fee-slider').noUiSlider.updateOptions({range: { min: step, max: max_fee }});
                        });
                    break;

                    case 'Destroy':
                        all_events.stopWatching();
                    break;
                }
            });
            render(proxy);
            collect_data(proxy);
        };

        var collect_old_events = function (data) {
            web3.eth.getBlockNumber(function (e, r) {
                var to_block = r;
                data.contract.Play({_sender: [web3.eth.accounts[0]]}, { fromBlock: data.create_block, toBlock: to_block }, function (e, r) {
                    if (e) { console.log(e); return; }
                    render_play(r);
                });
            });
        };

        var collect_data = function (data) {
            var contract = data.contract;
            web3.eth.getBalance(data.address, function (e, r) { data.balance = r; });
            contract.owner(function (e, r) { data.owner = r; });
            contract.max_fee(function (e, r) {
                data.max_fee = r;
                create_sliders(r);
            });
            contract.create_block(function (e, r) {
                data.create_block = r;
                setTimeout(function () {
                    collect_old_events(data);
                }, 2000);
            });
            contract.last_result(function (e, r) { data.last_result = r; });
            data.address = data.address;
        };

        var time_ago = function (timestamp) {
			var d = new Date();
			var now = Math.floor(d.getTime() / 1000);
			var seconds = now - timestamp;
			if (seconds > 2 * 86400) {
               return Math.floor(seconds / 86400) + ' days ago';
			}
			if (seconds > 86400) {
			   return 'yesterday';
			}
			if (seconds > 3600) {
               return Math.floor(seconds / 3600) + ' hours ago';
			}
			if (seconds > 60) {
			   return Math.floor(seconds / 60) + ' min ago';
			}
			return 'a few sec ago';
        }

        var update_time_ago = function () {
            var times = document.getElementsByTagName('time');
            for (var i = 0; i < times.length; i++) {
                times[i].innerText = time_ago(times[i].dataset.timestamp);
            }
        };

        var render_play = function (play_event) {
            id = play_event.transactionHash;
            var el = document.getElementById(id);
            if (!el) {
                var article = document.getElementById('play');
                var div = document.createElement('div');
                div.id = id;
                div.className = 'line';

                var time = document.createElement('time');
                time.dataset.timestamp = play_event.args._time;
                var text = document.createTextNode(time_ago(play_event.args._time));
                time.appendChild(text);
                div.appendChild(time);

                if (play_event.args._winner) {
                    div.className = 'line winner';
                }
                var text = document.createTextNode('start: ' + parseInt(play_event.args._start) + ' end: ' + parseInt(play_event.args._end) + ' result: ' + parseInt(play_event.args._result));
                div.appendChild(text);
                article.prepend(div);
            }
        };

        var render = function (data) {
            var section = document.getElementById('section');
            var article = document.createElement('article');
            article.id = data.address;
            for (var key in data) {
                if (key == 'contract') {
                    continue;
                }
                var span = document.createElement('span');
                span.id = key;
                var text = document.createTextNode(data[key]);
                span.appendChild(text);
                var div = document.createElement('div');
                div.className = 'line';
                var text = document.createTextNode(key + ': ');
                div.appendChild(text);
                div.appendChild(span);
                article.appendChild(div);
            }
            var div = document.createElement('div');
            div.className = 'line';
            div.id = 'play-error';
            div.style = 'color: #f00;';
            var text = document.createTextNode('');
            div.appendChild(text);
            article.appendChild(div);

            var div = document.createElement('div');
            div.className = 'line';

            var guess_slider = document.createElement('div');
            guess_slider.id = 'guess-slider';
            div.appendChild(guess_slider);

            var fee_slider = document.createElement('div');
            fee_slider.id = 'fee-slider';
            div.appendChild(fee_slider);

            var input = document.createElement('input');
            input.id = 'submit';
            input.type = 'button';
            input.value = 'PLAY'
            input.addEventListener('click', function () {
                play(data);
            });
            div.appendChild(input);

            article.appendChild(div);

            var div = document.createElement('div');
            div.className = 'line';
            div.id = 'play';
            article.appendChild(div);

            section.appendChild(article);

			setInterval(function () {
				update_time_ago();
			}, 60000);
        };

        var create_sliders = function (max_fee) {
            var guess_slider = document.getElementById('guess-slider');
            noUiSlider.create(guess_slider, {
                start: [1, 255],
                step: 1,
                behaviour: 'drag',
                connect: [true, true, true],
                tooltips: true,
                range: {
                    'min': 1,
                    'max': 255
                },
                format: {
                    to: function (value) { return parseInt(value); },
                    from: function (value) { return parseInt(value); }
                }
            });
            var connect = guess_slider.querySelectorAll('.noUi-connect');
            connect[0].classList.add('red');
            connect[1].classList.add('green');
            connect[2].classList.add('red');

            max_fee = parseInt(max_fee / step * step);

            var fee_slider = document.getElementById('fee-slider');
            noUiSlider.create(fee_slider, {
                start: 0.1,
                step: step,
                connect: [true, false],
                tooltips: true,
                range: {
                    'min': step,
                    'max': max_fee
                },
                format: {
                    to: function (value) { return parseFloat(web3.fromWei(value, 'ether')).toFixed(3) + 'ETH'; },
                    from: function (value) { return web3.toWei(value.replace('ETH',''), 'ether'); }
                }
            });
            var connect = fee_slider.querySelectorAll('.noUi-connect');
            connect[0].classList.add('green');
        };

        var play = function (data) {
            if (!web3.eth.accounts[0]) {
                document.getElementById('play-error').innerText = 'Unlock metamstk account';
                return;
            }
            document.getElementById('play-error').innerText = '';
            var guess_slider = document.getElementById('guess-slider').noUiSlider.get()
            var start = ('0' + guess_slider[0].toString(16)).slice(-2);
            var end = ('0' + guess_slider[1].toString(16)).slice(-2);
            var fee = web3.toWei(document.getElementById('fee-slider').noUiSlider.get().replace('ETH',''), 'ether');
            if (start.length == 2 && start.match(/[0-9a-f]{2}/) &&
                end.length == 2 && end.match(/[0-9a-f]{2}/) &&
                fee.length > 0 && fee.match(/[0-9]+/)) {
                start = "0x" + start;
                end = "0x" + end;
                data.contract.play(start, end, { from : web3.eth.accounts[0], value: fee }, function (e, r) {
                    if (e) {
                        document.getElementById('play-error').innerText = e.message;
                        console.log(e.message);
                    }
                    if (r) {
                        console.log('play tx ' + r);
                    }
                });
            }
            else {
                document.getElementById('play-error').innerText = 'enter start and end bytes';
            }
        };

        var address = '0x995f617066a6968749eb980c2613314f4d45d4ab';
        var contract = web3.eth.contract(abi);
        var ETHBlockByte = contract.at(address);
        var step = 1000000000000000; // 0.001 ETH
        init(address, ETHBlockByte);

        return { play: play };
    };

    var app = null;
    window.addEventListener('load', function() {
        app = bootstrap();
    }, false );
</script>
</head>

<body>
    <h1>ETHBlockByte</h1>

    <div id="error"></div>

    <section id="section">
    </section>
</body>

</html>
